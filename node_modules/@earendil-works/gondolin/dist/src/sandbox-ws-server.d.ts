import { EventEmitter } from "events";
import { SandboxState } from "./sandbox-controller";
import type { HttpFetch, HttpHooks } from "./qemu-net";
import type { SandboxPolicy } from "./policy";
import { SandboxVfsProvider, type VirtualProvider } from "./vfs";
import { type GuestAssets } from "./assets";
export type SandboxWsServerOptions = {
    host?: string;
    port?: number;
    qemuPath?: string;
    kernelPath?: string;
    initrdPath?: string;
    rootfsPath?: string;
    memory?: string;
    cpus?: number;
    virtioSocketPath?: string;
    virtioFsSocketPath?: string;
    netSocketPath?: string;
    netMac?: string;
    netEnabled?: boolean;
    netDebug?: boolean;
    machineType?: string;
    accel?: string;
    cpu?: string;
    console?: "stdio" | "none";
    token?: string;
    autoRestart?: boolean;
    append?: string;
    maxJsonBytes?: number;
    maxStdinBytes?: number;
    policy?: SandboxPolicy;
    fetch?: HttpFetch;
    httpHooks?: HttpHooks;
    mitmCertDir?: string;
    vfsProvider?: VirtualProvider;
};
export type SandboxWsServerAddress = {
    host: string;
    port: number;
    url: string;
};
export type ResolvedServerOptions = {
    host: string;
    port: number;
    qemuPath: string;
    kernelPath: string;
    initrdPath: string;
    rootfsPath: string;
    memory: string;
    cpus: number;
    virtioSocketPath: string;
    virtioFsSocketPath: string;
    netSocketPath: string;
    netMac: string;
    netEnabled: boolean;
    netDebug: boolean;
    machineType?: string;
    accel?: string;
    cpu?: string;
    console?: "stdio" | "none";
    token?: string;
    autoRestart: boolean;
    append?: string;
    maxJsonBytes: number;
    maxStdinBytes: number;
    policy: SandboxPolicy | null;
    fetch?: HttpFetch;
    httpHooks?: HttpHooks;
    mitmCertDir?: string;
    vfsProvider: VirtualProvider | null;
};
/**
 * Resolve server options synchronously.
 *
 * This version uses local development paths if available. For production use,
 * prefer `resolveSandboxWsServerOptionsAsync` which will download assets if needed.
 *
 * @param options User-provided options
 * @param assets Optional pre-resolved guest assets (from ensureGuestAssets)
 */
export declare function resolveSandboxWsServerOptions(options?: SandboxWsServerOptions, assets?: GuestAssets): ResolvedServerOptions;
/**
 * Resolve server options asynchronously, downloading guest assets if needed.
 *
 * This is the recommended way to get resolved options for production use.
 */
export declare function resolveSandboxWsServerOptionsAsync(options?: SandboxWsServerOptions): Promise<ResolvedServerOptions>;
export declare class SandboxWsServer extends EventEmitter {
    private readonly options;
    private readonly controller;
    private readonly bridge;
    private readonly fsBridge;
    private readonly network;
    private readonly baseAppend;
    private wss;
    private vfsProvider;
    private fsService;
    private inflight;
    private stdinAllowed;
    private startPromise;
    private stopPromise;
    private address;
    private policy;
    private qemuLogBuffer;
    private status;
    private bootConfig;
    private activeClient;
    /**
     * Create a SandboxWsServer, downloading guest assets if needed.
     *
     * This is the recommended way to create a server in production, as it will
     * automatically download the guest image if it's not available locally.
     *
     * @param options Server configuration options
     * @returns A configured SandboxWsServer instance
     */
    static create(options?: SandboxWsServerOptions): Promise<SandboxWsServer>;
    /**
     * Create a SandboxWsServer synchronously.
     *
     * This constructor requires that guest assets are available locally (either
     * in a development checkout or via GONDOLIN_GUEST_DIR). For automatic asset
     * downloading, use the async `SandboxWsServer.create()` factory instead.
     *
     * @param options Server configuration options (or pre-resolved options)
     */
    constructor(options?: SandboxWsServerOptions | ResolvedServerOptions);
    getAddress(): SandboxWsServerAddress | null;
    getUrl(): string | null;
    getState(): SandboxState;
    getPolicy(): SandboxPolicy | null;
    getVfsProvider(): SandboxVfsProvider | null;
    getFsMetrics(): import("./vfs").FsRpcMetrics | null;
    setPolicy(policy: SandboxPolicy | null): void;
    start(): Promise<SandboxWsServerAddress>;
    stop(): Promise<void>;
    private startInternal;
    private stopInternal;
    private handleConnection;
    private handleBoot;
    private handleExec;
    private handleStdin;
    private handlePtyResize;
    private handlePolicy;
    private failInflight;
}
//# sourceMappingURL=sandbox-ws-server.d.ts.map